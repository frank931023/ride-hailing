<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>簡易乘車配對系統</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            --primary-color: #4361ee;
            --secondary-color: #3f37c9;
            --success-color: #06d6a0;
            --warning-color: #f77f00;
            --danger-color: #ef476f;
            --light-bg: #f8f9fa;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .main-container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
            max-width: 1800px;
            margin: 0 auto;
        }

        .header {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            margin: 0;
            font-weight: 700;
            font-size: 2.5rem;
        }

        .content-wrapper {
            display: flex;
            min-height: calc(100vh - 140px);
        }

        .passenger-section {
            flex: 1;
            border-right: 3px solid #e9ecef;
            padding: 30px;
            background: #fafbfc;
        }

        .drivers-section {
            flex: 1;
            padding: 30px;
            display: grid;
            grid-template-columns: 1fr 1fr;
            grid-template-rows: 1fr 1fr;
            gap: 20px;
        }

        .section-title {
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--primary-color);
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 3px solid var(--primary-color);
        }

        .driver-card {
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            border: 2px solid #e9ecef;
            transition: all 0.3s ease;
        }

        .driver-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.15);
        }

        .driver-header {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #e9ecef;
        }

        .driver-icon {
            width: 50px;
            height: 50px;
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.5rem;
            margin-right: 15px;
        }

        .driver-info h4 {
            margin: 0;
            font-size: 1.2rem;
            font-weight: 600;
        }

        .driver-info p {
            margin: 0;
            font-size: 0.85rem;
            color: #6c757d;
        }

        .status-badge {
            display: inline-block;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
            margin-top: 10px;
        }

        .status-available {
            background: #d4edda;
            color: #155724;
        }

        .status-busy {
            background: #f8d7da;
            color: #721c24;
        }

        .status-initiate {
            background: #fff3cd;
            color: #856404;
        }

        .status-matched {
            background: #d1ecf1;
            color: #0c5460;
        }

        .status-cancelled {
            background: #f8d7da;
            color: #721c24;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            font-weight: 600;
            color: #495057;
            margin-bottom: 8px;
        }

        .form-control {
            border-radius: 10px;
            border: 2px solid #e9ecef;
            padding: 12px;
            transition: all 0.3s ease;
        }

        .form-control:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 0.2rem rgba(67, 97, 238, 0.25);
        }

        .btn {
            border-radius: 10px;
            padding: 12px 24px;
            font-weight: 600;
            transition: all 0.3s ease;
            border: none;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(67, 97, 238, 0.4);
        }

        .btn-danger {
            background: var(--danger-color);
        }

        .btn-danger:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(239, 71, 111, 0.4);
        }

        .btn-success {
            background: var(--success-color);
        }

        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(6, 214, 160, 0.4);
        }

        .btn-warning {
            background: var(--warning-color);
            color: white;
        }

        .btn-sm {
            padding: 8px 16px;
            font-size: 0.875rem;
        }

        .ride-info-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 25px;
            border: 2px solid var(--primary-color);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .info-row {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid #e9ecef;
        }

        .info-row:last-child {
            border-bottom: none;
        }

        .info-label {
            font-weight: 600;
            color: #6c757d;
        }

        .info-value {
            color: #212529;
            font-weight: 500;
        }

        .bids-container {
            max-height: 400px;
            overflow-y: auto;
        }

        .bid-card {
            background: white;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
            transition: all 0.3s ease;
        }

        .bid-card:hover {
            border-color: var(--primary-color);
            box-shadow: 0 4px 12px rgba(67, 97, 238, 0.2);
        }

        .bid-card.selected {
            border-color: var(--success-color);
            background: #f0fdf4;
        }

        .bid-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .bid-driver {
            font-weight: 700;
            color: var(--primary-color);
            font-size: 1.1rem;
        }

        .bid-price {
            font-size: 1.3rem;
            font-weight: 700;
            color: var(--success-color);
        }

        .bid-details {
            color: #6c757d;
            font-size: 0.9rem;
            margin-bottom: 10px;
        }

        .notification-card {
            background: #fff3cd;
            border-left: 4px solid var(--warning-color);
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 15px;
        }

        .notification-card h5 {
            margin: 0 0 10px 0;
            color: #856404;
            font-weight: 600;
        }

        .notification-card p {
            margin: 5px 0;
            color: #856404;
            font-size: 0.9rem;
        }

        .bid-form {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 15px;
            margin-top: 15px;
        }

        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #6c757d;
        }

        .empty-state i {
            font-size: 3rem;
            margin-bottom: 15px;
            opacity: 0.5;
        }

        .contact-info {
            background: linear-gradient(135deg, var(--success-color), #00b894);
            color: white;
            border-radius: 15px;
            padding: 25px;
            margin-top: 20px;
        }

        .contact-info h4 {
            margin-bottom: 15px;
            font-weight: 700;
        }

        .contact-item {
            background: rgba(255,255,255,0.2);
            border-radius: 10px;
            padding: 12px;
            margin-bottom: 10px;
        }

        .scrollbar::-webkit-scrollbar {
            width: 8px;
        }

        .scrollbar::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }

        .scrollbar::-webkit-scrollbar-thumb {
            background: var(--primary-color);
            border-radius: 10px;
        }
    </style>
</head>
<body>
    <div class="main-container">
        <div class="header">
            <h1><i class="fas fa-car"></i> 簡易乘車配對系統</h1>
            <p style="margin: 10px 0 0 0; opacity: 0.9;">即時乘客與司機配對平台</p>
        </div>

        <div class="content-wrapper">
            <!-- 左側：乘客介面 -->
            <div class="passenger-section">
                <div class="section-title">
                    <i class="fas fa-user"></i> 乘客介面
                </div>

                <!-- 建立行程表單 -->
                <div id="requestForm">
                    <div class="form-group">
                        <label class="form-label">上車地點</label>
                        <input type="text" class="form-control" id="pickUpLocation" placeholder="例：台北車站" 
                            onfocus="isInputting = true" onblur="isInputting = false">
                    </div>
                    <div class="form-group">
                        <label class="form-label">目的地</label>
                        <input type="text" class="form-control" id="destination" placeholder="例：松山機場" 
                            onfocus="isInputting = true" onblur="isInputting = false">
                    </div>
                    <div class="form-group">
                        <label class="form-label">預計上車時間</label>
                        <input type="text" class="form-control" id="expectedPickUpTime" placeholder="例：今天下午3點" 
                            onfocus="isInputting = true" onblur="isInputting = false">
                    </div>
                    <button class="btn btn-primary w-100" onclick="createRideRequest()">
                        <i class="fas fa-paper-plane"></i> 發送乘車請求
                    </button>
                </div>

                <!-- 當前行程資訊 -->
                <div id="currentRideInfo" style="display: none;">
                    <div class="ride-info-card">
                        <h5 style="color: var(--primary-color); margin-bottom: 20px;">
                            <i class="fas fa-info-circle"></i> 當前行程資訊
                        </h5>
                        <div class="info-row">
                            <span class="info-label">上車地點：</span>
                            <span class="info-value" id="currentPickUp"></span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">目的地：</span>
                            <span class="info-value" id="currentDestination"></span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">預計時間：</span>
                            <span class="info-value" id="currentTime"></span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">狀態：</span>
                            <span id="currentStatus"></span>
                        </div>
                        <button class="btn btn-danger w-100 mt-3" onclick="cancelRideRequest()">
                            <i class="fas fa-times"></i> 取消行程
                        </button>
                    </div>

                    <!-- 報價列表 -->
                    <div id="bidsSection">
                        <h5 style="color: var(--primary-color); margin-bottom: 20px;">
                            <i class="fas fa-list"></i> 司機報價列表
                        </h5>
                        <div id="bidsList" class="bids-container scrollbar"></div>
                    </div>

                    <!-- 配對完成資訊 -->
                    <div id="matchedInfo" style="display: none;"></div>
                </div>
            </div>

            <!-- 右側：司機介面 (2x2) -->
            <div class="drivers-section">
                <!-- Driver 1 -->
                <div class="driver-card" id="driver1Card">
                    <div class="driver-header">
                        <div class="driver-icon">
                            <i class="fas fa-user-tie"></i>
                        </div>
                        <div class="driver-info">
                            <h4>Driver 1</h4>
                            <p id="vehicle1">Toyota Camry - ABC123</p>
                        </div>
                    </div>
                    <span class="status-badge status-available" id="status1">可接單</span>
                    <button class="btn btn-sm btn-outline-primary w-100 mt-2" id="toggleBtn1" onclick="toggleDriverAvailability(1)">
                        <i class="fas fa-power-off"></i> <span id="toggleText1">下線</span>
                    </button>
                    <div id="notification1" style="display: none;"></div>
                    <div id="bidForm1" style="display: none;"></div>
                    <div id="myBids1"></div>
                </div>

                <!-- Driver 2 -->
                <div class="driver-card" id="driver2Card">
                    <div class="driver-header">
                        <div class="driver-icon">
                            <i class="fas fa-user-tie"></i>
                        </div>
                        <div class="driver-info">
                            <h4>Driver 2</h4>
                            <p id="vehicle2">Honda Civic - XYZ789</p>
                        </div>
                    </div>
                    <span class="status-badge status-available" id="status2">可接單</span>
                    <button class="btn btn-sm btn-outline-primary w-100 mt-2" id="toggleBtn2" onclick="toggleDriverAvailability(2)">
                        <i class="fas fa-power-off"></i> <span id="toggleText2">下線</span>
                    </button>
                    <div id="notification2" style="display: none;"></div>
                    <div id="bidForm2" style="display: none;"></div>
                    <div id="myBids2"></div>
                </div>

                <!-- Driver 3 -->
                <div class="driver-card" id="driver3Card">
                    <div class="driver-header">
                        <div class="driver-icon">
                            <i class="fas fa-user-tie"></i>
                        </div>
                        <div class="driver-info">
                            <h4>Driver 3</h4>
                            <p id="vehicle3">Tesla Model 3 - TES456</p>
                        </div>
                    </div>
                    <span class="status-badge status-available" id="status3">可接單</span>
                    <button class="btn btn-sm btn-outline-primary w-100 mt-2" id="toggleBtn3" onclick="toggleDriverAvailability(3)">
                        <i class="fas fa-power-off"></i> <span id="toggleText3">下線</span>
                    </button>
                    <div id="notification3" style="display: none;"></div>
                    <div id="bidForm3" style="display: none;"></div>
                    <div id="myBids3"></div>
                </div>

                <!-- Driver 4 -->
                <div class="driver-card" id="driver4Card">
                    <div class="driver-header">
                        <div class="driver-icon">
                            <i class="fas fa-user-tie"></i>
                        </div>
                        <div class="driver-info">
                            <h4>Driver 4</h4>
                            <p id="vehicle4">BMW 3 Series - BMW999</p>
                        </div>
                    </div>
                    <span class="status-badge status-available" id="status4">可接單</span>
                    <button class="btn btn-sm btn-outline-primary w-100 mt-2" id="toggleBtn4" onclick="toggleDriverAvailability(4)">
                        <i class="fas fa-power-off"></i> <span id="toggleText4">下線</span>
                    </button>
                    <div id="notification4" style="display: none;"></div>
                    <div id="bidForm4" style="display: none;"></div>
                    <div id="myBids4"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = '/api/rides';
        let currentRequest = null;
        let allBids = [];
        let drivers = {};
        let driverAvailability = {
            '1': true,
            '2': true,
            '3': true,
            '4': true
        };
        let isInputting = false;  // 標記是否正在輸入
        let refreshInterval = null;  // 刷新計時器

        // 初始化
        async function init() {
            await loadDrivers();
            await refreshCurrentRequest();
            // 使用可控制的計時器
            refreshInterval = setInterval(() => {
                if (!isInputting) {  // 只在不輸入時刷新
                    refreshCurrentRequest();
                }
            }, 2000);
        }

        // 載入司機資訊
        async function loadDrivers() {
            try {
                const response = await fetch(`${API_BASE}/drivers`);
                const driversList = await response.json();
                driversList.forEach(driver => {
                    drivers[driver.id] = driver;
                });
            } catch (error) {
                console.error('載入司機資訊失敗:', error);
            }
        }

        // 建立乘車請求
        async function createRideRequest() {
            const pickUpLocation = document.getElementById('pickUpLocation').value;
            const destination = document.getElementById('destination').value;
            const expectedPickUpTime = document.getElementById('expectedPickUpTime').value;

            if (!pickUpLocation || !destination || !expectedPickUpTime) {
                alert('請填寫所有欄位！');
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/request`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ pickUpLocation, destination, expectedPickUpTime })
                });
                
                currentRequest = await response.json();
                document.getElementById('requestForm').style.display = 'none';
                document.getElementById('currentRideInfo').style.display = 'block';
                updateUI();
            } catch (error) {
                console.error('建立請求失敗:', error);
                alert('建立請求失敗，請稍後再試！');
            }
        }

        // 取消行程
        async function cancelRideRequest() {
            if (!confirm('確定要取消此行程嗎？')) return;

            try {
                await fetch(`${API_BASE}/cancel`, { method: 'POST' });
                // 立即清空當前請求和報價
                currentRequest = null;
                allBids = [];
                // 重置 UI
                resetUI();
            } catch (error) {
                console.error('取消失敗:', error);
                alert('取消失敗，請稍後再試！');
            }
        }

        // 司機提交報價
        async function submitBid(driverId, driverNum) {
            const priceInput = document.getElementById(`bidPrice${driverNum}`);
            const price = parseInt(priceInput.value);

            if (!price || price <= 0) {
                alert('請輸入有效的報價金額！');
                return;
            }

            try {
                isInputting = false;  // 提交後恢復刷新
                await fetch(`${API_BASE}/bids/submit`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ driverId, price })
                });
                priceInput.value = '';
                await refreshCurrentRequest();
            } catch (error) {
                console.error('提交報價失敗:', error);
                isInputting = false;
            }
        }

        // 司機撤回報價
        async function withdrawBid(bidId, driverId) {
            try {
                await fetch(`${API_BASE}/bids/withdraw`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ bidId, driverId })
                });
                await refreshCurrentRequest();
            } catch (error) {
                console.error('撤回報價失敗:', error);
            }
        }

        // 切換司機上線/下線狀態
        async function toggleDriverAvailability(driverNum) {
            const driverId = driverNum.toString();
            const newStatus = !driverAvailability[driverId];
            
            try {
                await fetch(`${API_BASE}/driver-status`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ driverId, available: newStatus })
                });
                
                driverAvailability[driverId] = newStatus;
                
                // 如果司機下線，立即清空該司機的通知、報價表單和已提交報價
                if (!newStatus) {
                    document.getElementById(`notification${driverNum}`).style.display = 'none';
                    document.getElementById(`bidForm${driverNum}`).style.display = 'none';
                    document.getElementById(`myBids${driverNum}`).innerHTML = '';
                }
                
                updateDriverStatus(driverNum);
                await refreshCurrentRequest();
            } catch (error) {
                console.error('切換狀態失敗:', error);
            }
        }

        // 更新司機狀態顯示
        function updateDriverStatus(driverNum) {
            const driverId = driverNum.toString();
            const statusEl = document.getElementById(`status${driverNum}`);
            const toggleTextEl = document.getElementById(`toggleText${driverNum}`);
            const toggleBtnEl = document.getElementById(`toggleBtn${driverNum}`);
            
            if (driverAvailability[driverId]) {
                statusEl.className = 'status-badge status-available';
                statusEl.textContent = '可接單';
                toggleTextEl.textContent = '下線';
                toggleBtnEl.className = 'btn btn-sm btn-outline-danger w-100 mt-2';
            } else {
                statusEl.className = 'status-badge status-busy';
                statusEl.textContent = '已下線';
                toggleTextEl.textContent = '上線';
                toggleBtnEl.className = 'btn btn-sm btn-outline-success w-100 mt-2';
            }
        }

        // 乘客選擇報價
        async function selectBid(bidId) {
            if (!confirm('確定選擇此報價嗎？選擇後將無法撤回！')) return;

            try {
                await fetch(`${API_BASE}/bids/select`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ bidId })
                });
                await refreshCurrentRequest();
            } catch (error) {
                console.error('選擇報價失敗:', error);
            }
        }

        // 刷新當前請求
        async function refreshCurrentRequest() {
            try {
                const response = await fetch(`${API_BASE}/current`);
                
                // 檢查響應是否有內容
                const text = await response.text();
                const data = text ? JSON.parse(text) : null;
                
                if (data && data.id) {
                    currentRequest = data;
                    const bidsResponse = await fetch(`${API_BASE}/bids`);
                    const bidsText = await bidsResponse.text();
                    allBids = bidsText ? JSON.parse(bidsText) : [];
                    updateUI();
                } else {
                    // 只有在之前有請求的情況下才重置UI
                    if (currentRequest !== null) {
                        currentRequest = null;
                        allBids = [];
                        resetUI();
                    }
                }
            } catch (error) {
                console.error('刷新失敗:', error);
            }
        }

        // 更新UI
        function updateUI() {
            if (!currentRequest || !currentRequest.id) {
                resetUI();
                return;
            }

            // 更新乘客介面
            document.getElementById('requestForm').style.display = 'none';
            document.getElementById('currentRideInfo').style.display = 'block';
            document.getElementById('currentPickUp').textContent = currentRequest.pickUpLocation;
            document.getElementById('currentDestination').textContent = currentRequest.destination;
            document.getElementById('currentTime').textContent = currentRequest.expectedPickUpTime;
            
            const statusEl = document.getElementById('currentStatus');
            let statusClass = 'status-initiate';
            let statusText = '等待報價';
            
            if (currentRequest.status === 'MATCHED') {
                statusClass = 'status-matched';
                statusText = '已配對';
                document.getElementById('bidsSection').style.display = 'none';
                showMatchedInfo();
            } else if (currentRequest.status === 'CANCELLED') {
                statusClass = 'status-cancelled';
                statusText = '已取消';
            }
            
            statusEl.innerHTML = `<span class="status-badge ${statusClass}">${statusText}</span>`;

            // 更新報價列表
            if (currentRequest.status === 'INITIATE') {
                updateBidsList();
            }

            // 更新司機介面
            for (let i = 1; i <= 4; i++) {
                updateDriverUI(i);
            }
        }

        // 更新報價列表
        function updateBidsList() {
            const bidsList = document.getElementById('bidsList');
            const pendingBids = allBids.filter(bid => bid.status === 'PENDING');
            
            if (pendingBids.length === 0) {
                bidsList.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-inbox"></i>
                        <p>尚無司機報價</p>
                    </div>
                `;
                return;
            }

            bidsList.innerHTML = pendingBids.map(bid => {
                const driver = drivers[bid.driverId];
                if (!driver) return '';
                
                return `
                    <div class="bid-card">
                        <div class="bid-header">
                            <span class="bid-driver">${driver.name}</span>
                            <span class="bid-price">NT$ ${bid.price}</span>
                        </div>
                        <div class="bid-details">
                            <i class="fas fa-car"></i> ${driver.vehicleInfo}
                        </div>
                        <div class="bid-details">
                            <i class="fas fa-phone"></i> ${driver.phoneNumber}
                        </div>
                        <button class="btn btn-success btn-sm w-100 mt-2" onclick="selectBid('${bid.id}')">
                            <i class="fas fa-check"></i> 選擇此司機
                        </button>
                    </div>
                `;
            }).join('');
        }

        // 顯示配對完成資訊
        async function showMatchedInfo() {
            try {
                const response = await fetch(`${API_BASE}/contact-info`);
                const data = await response.json();
                const selectedBid = currentRequest.selectedBid;
                const driver = drivers[selectedBid.driverId];
                
                document.getElementById('matchedInfo').style.display = 'block';
                document.getElementById('matchedInfo').innerHTML = `
                    <div class="contact-info">
                        <h4><i class="fas fa-check-circle"></i> 配對成功！</h4>
                        <div class="contact-item">
                            <strong>司機姓名：</strong> ${driver.name}
                        </div>
                        <div class="contact-item">
                            <strong>司機電話：</strong> ${driver.phoneNumber}
                        </div>
                        <div class="contact-item">
                            <strong>車輛資訊：</strong> ${driver.vehicleInfo}
                        </div>
                        <div class="contact-item">
                            <strong>報價金額：</strong> NT$ ${selectedBid.price}
                        </div>
                        <p style="margin-top: 15px; opacity: 0.9;">
                            <i class="fas fa-info-circle"></i> 請聯繫司機確認行程細節
                        </p>
                    </div>
                `;
            } catch (error) {
                console.error('載入聯絡資訊失敗:', error);
            }
        }

        // 更新司機介面
        function updateDriverUI(driverNum) {
            const driverId = driverNum.toString();
            const notificationEl = document.getElementById(`notification${driverNum}`);
            const bidFormEl = document.getElementById(`bidForm${driverNum}`);
            const myBidsEl = document.getElementById(`myBids${driverNum}`);
            const statusEl = document.getElementById(`status${driverNum}`);

            // 檢查司機是否在線
            const isAvailable = driverAvailability[driverId];
            
            // 如果司機下線，清空所有內容並返回
            if (!isAvailable) {
                notificationEl.style.display = 'none';
                bidFormEl.style.display = 'none';
                myBidsEl.innerHTML = '';
                updateDriverStatus(driverNum);
                return;
            }

            // 如果沒有當前請求，清空所有內容
            if (!currentRequest || !currentRequest.id) {
                notificationEl.style.display = 'none';
                bidFormEl.style.display = 'none';
                myBidsEl.innerHTML = '';
                updateDriverStatus(driverNum);
                return;
            }

            // 顯示通知（只在INITIATE狀態且司機在線時）
            if (currentRequest.status === 'INITIATE' && isAvailable) {
                notificationEl.style.display = 'block';
                notificationEl.innerHTML = `
                    <div class="notification-card">
                        <h5><i class="fas fa-bell"></i> 新的乘車請求</h5>
                        <p><i class="fas fa-map-marker-alt"></i> ${currentRequest.pickUpLocation} → ${currentRequest.destination}</p>
                        <p><i class="fas fa-clock"></i> ${currentRequest.expectedPickUpTime}</p>
                    </div>
                `;

                // 檢查是否有待處理或已撤回的報價
                const myBids = allBids.filter(bid => bid.driverId === driverId);
                const hasPendingBid = myBids.some(bid => bid.status === 'PENDING');
                
                // 只有在沒有待處理報價且司機在線時才顯示報價表單
                if (!hasPendingBid && isAvailable) {
                    bidFormEl.style.display = 'block';
                    bidFormEl.innerHTML = `
                        <div class="bid-form">
                            <label class="form-label">我的報價（NT$）</label>
                            <div class="input-group mb-2">
                                <input type="number" class="form-control" id="bidPrice${driverNum}" placeholder="輸入金額" 
                                    onfocus="isInputting = true" 
                                    onblur="isInputting = false">
                            </div>
                            <button class="btn btn-success btn-sm w-100" onclick="submitBid('${driverId}', ${driverNum})">
                                <i class="fas fa-paper-plane"></i> 提交報價
                            </button>
                        </div>
                    `;
                } else if (hasPendingBid) {
                    bidFormEl.style.display = 'none';
                }
            } else {
                notificationEl.style.display = 'none';
                if (currentRequest.status !== 'INITIATE') {
                    bidFormEl.style.display = 'none';
                }
            }

            // 顯示我的報價
            const myBids = allBids.filter(bid => bid.driverId === driverId);
            const pendingBids = myBids.filter(bid => bid.status === 'PENDING');
            const withdrawnBids = myBids.filter(bid => bid.status === 'WITHDRAWN');
            
            if (myBids.length > 0) {
                myBidsEl.innerHTML = myBids.map(bid => {
                    const isSelected = currentRequest.selectedBid && currentRequest.selectedBid.id === bid.id;
                    
                    if (isSelected) {
                        statusEl.className = 'status-badge status-matched';
                        statusEl.textContent = '已配對';
                        return `
                            <div class="bid-form" style="background: #d1f2eb; border: 2px solid var(--success-color);">
                                <h6 style="color: var(--success-color); margin-bottom: 10px;">
                                    <i class="fas fa-check-circle"></i> 您的報價已被選中！
                                </h6>
                                <p style="font-size: 1.2rem; font-weight: 700; color: var(--success-color); margin: 0;">
                                    NT$ ${bid.price}
                                </p>
                                <p style="margin-top: 10px; color: #6c757d; font-size: 0.9rem;">
                                    乘客電話：${currentRequest.passenger.phoneNumber}
                                </p>
                            </div>
                        `;
                    }
                    
                    if (bid.status === 'PENDING') {
                        return `
                            <div class="bid-form">
                                <h6 style="color: var(--primary-color); margin-bottom: 10px;">我的報價</h6>
                                <p style="font-size: 1.2rem; font-weight: 700; color: var(--primary-color); margin: 0;">
                                    NT$ ${bid.price}
                                </p>
                                <button class="btn btn-warning btn-sm w-100 mt-2" onclick="withdrawBid('${bid.id}', '${driverId}')">
                                    <i class="fas fa-undo"></i> 撤回報價
                                </button>
                            </div>
                        `;
                    }
                    
                    // 撤回的報價只在 INITIATE 狀態顯示（其他狀態會被清空）
                    if (bid.status === 'WITHDRAWN' && currentRequest.status === 'INITIATE') {
                        return `
                            <div class="bid-form" style="background: #f8d7da; border: 2px solid var(--danger-color);">
                                <p style="color: #721c24; margin: 0 0 10px 0; font-weight: 600;">報價已撤回</p>
                                <p style="color: #721c24; margin: 0; font-size: 0.85rem;">已撤回金額：NT$ ${bid.price}</p>
                            </div>
                        `;
                    }
                    
                    return '';
                }).join('');
                
                // 如果沒有待處理報價且狀態是INITIATE，顯示報價表單（允許重新報價）
                if (pendingBids.length === 0 && currentRequest.status === 'INITIATE' && isAvailable) {
                    bidFormEl.style.display = 'block';
                }
            } else {
                myBidsEl.innerHTML = '';
                if (currentRequest.status !== 'INITIATE') {
                    updateDriverStatus(driverNum);
                }
            }
        }

        // 重置UI
        function resetUI() {
            // 顯示請求表單
            document.getElementById('requestForm').style.display = 'block';
            document.getElementById('currentRideInfo').style.display = 'none';
            document.getElementById('matchedInfo').style.display = 'none';
            document.getElementById('bidsSection').style.display = 'block';
            
            // 清空輸入欄位
            document.getElementById('pickUpLocation').value = '';
            document.getElementById('destination').value = '';
            document.getElementById('expectedPickUpTime').value = '';
            
            // 清空報價列表
            document.getElementById('bidsList').innerHTML = '';
            
            // 清理所有司機介面
            for (let i = 1; i <= 4; i++) {
                document.getElementById(`notification${i}`).style.display = 'none';
                document.getElementById(`bidForm${i}`).style.display = 'none';
                document.getElementById(`myBids${i}`).innerHTML = '';
                updateDriverStatus(i);
            }
        }

        // 頁面載入時初始化
        window.onload = init;
    </script>
</body>
</html>